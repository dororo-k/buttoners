co# PDF 파일 업로드·열람 페이지 개발 매뉴얼

본 문서는 웹사이트(Next.js 기반)에서 PDF 파일을 업로드(클라이언트 선택) 및 열람할 수 있는 페이지를 개발하기 위한 체크리스트 중심의 가이드입니다. 간단형(브라우저 내장 뷰어)과 고급형(pdf.js) 두 가지 방식을 제공합니다.

## 핵심 체크리스트(요약)
- [x] 라우트 생성: `/manuals/viewer`
- [x] 업로드(로컬 선택) + URL 입력 폼 제공
- [x] 쿼리 `?src=<상대경로|절대URL>`로 직접 열람 가능
- [x] 보기 영역 70–80vh 이상, 반응형 레이아웃
- [ ] 잘못된 경로/CORS 차단 시 에러 안내 및 대체 링크 제공
- [x] 객체 URL 사용 시 `URL.revokeObjectURL`로 정리
- [ ] 보안 고려(CORS, HTTPS, CSP, 파일 크기/형식 제한)
- [ ] 접근성 레이블/키보드 포커스 보장
- [ ] 모바일 브라우저 제한 시 다운로드 fallback
- [x] (선택) pdf.js 적용: 워커/CMap/폰트 경로 설정 및 동적 import

---

## 1) 목표 및 범위
- [x] 사용자 로컬 기기에서 PDF 파일을 선택 후 즉시 브라우저에서 열람
- [x] 특정 URL 또는 정적 경로의 PDF를 직접 열람
- [x] 서버 업로드(영구 저장): 관리자 전용 업로드/삭제 구현(일반사용자 열람 전용)
- [x] MVP는 내장 뷰어 기반(iframe)으로 간단히 시작, 필요 시 pdf.js로 확장

### 권한/역할
- [x] 관리자(Admin): PDF 업로드/삭제 가능
- [x] 일반회원(User): 업로드된 PDF 열람만 가능, 삭제 권한 없음

### 카테고리
- [x] 카테고리로 문서를 분류 (예: `서비스`, `청소`, `기타`)

## 2) 전제조건
- [x] Next.js(App Router) 프로젝트 환경(예: `nextjs-portal`)
- [x] 정적 PDF는 `public/`에 배치하면 루트(`/`) 경로로 접근 가능
- [ ] 원격 PDF는 CORS 허용 필요(`Access-Control-Allow-Origin`)

## 3) 아키텍처 선택지
- [x] 간단형: 브라우저 내장 PDF 뷰어(iframe) 활용 — 구현 용이, 브라우저 기능 의존
- [x] 고급형: pdf.js — 페이지 네비게이션, 검색, 주석 등 고급 기능 구현 가능

---

## 4) 구현 체크리스트(MVP: iframe)
- [x] 페이지 라우트: `/manuals/viewer` 생성(클라이언트 컴포넌트)
- [x] UI 구성: 파일 선택(input type="file"), URL 입력(input type="url"), 불러오기 버튼
- [x] 상태 관리: `displaySrc`(현재 표시 중인 PDF), `objectUrl`(로컬 파일 미리보기 URL)
- [x] 파일 선택 시 `URL.createObjectURL(file)`로 `iframe`에 표시, 기존 URL은 `URL.revokeObjectURL`로 반환
- [x] URL 입력 시 공백 제거 및 유효성(https 권장) 기본 점검
- [x] 초기 진입 시 `?src=...` 쿼리로 바로 표시 가능
- [x] 뷰어: `iframe` 높이 70–80vh 이상, 가로/세로 100% 차지
- [x] PDF 미지정 시 안내 문구 표시
- [x] 전체화면 모드 지원: `/manuals/viewer?src=...&fullscreen=1`
- [x] 전체화면 좌측 레일(향후 pdf.js 적용 시 페이지 썸네일 표시)

### 오류 처리
- [ ] 잘못된 URL/경로 → 사용자 메시지 표시(“파일을 불러올 수 없습니다”)
- [ ] CORS 차단/서버 오류 → 메시지 + “새 탭에서 열기/다운로드” 대체 링크 제공
- [ ] 파일 용량 제한(예: 50MB) 및 MIME 타입(`application/pdf`) 점검

### 보안
- [x] 로컬 파일은 클라이언트 내 처리(서버 업로드 금지)
- [ ] 원격 PDF는 HTTPS 사용 권장, CORS 허용 필요
- [ ] CSP 고려: `blob:`(로컬 미리보기), 워커/폰트 경로(pdf.js 사용 시) 허용
- [ ] Firebase 보안 규칙: Firestore/Storage에 대해 관리자만 생성/삭제 허용, 일반 사용자는 읽기만 허용

### 접근성
- [x] 입력/버튼/iframe에 적절한 라벨/`title` 제공
- [x] 키보드로 조작 가능(탭 이동, 제출)

### 성능/호환성
- [ ] 초기 JS 최소화(iframe 사용 시 추가 번들 없음)
- [ ] 모바일 브라우저 인라인 PDF 제한 시 다운로드 안내
- [ ] 최신 Chrome/Edge/Firefox/Safari 및 모바일 브라우저 확인

---

- [x] 의존성 설치: `pdfjs-dist`
- [x] 워커 경로 설정: `GlobalWorkerOptions.workerSrc = '/pdf.worker.min.mjs'`
- [x] CMap/폰트 경로: `/pdfjs/cmaps/`, `/pdfjs/standard_fonts/`
- [x] `EventBus`, `PDFLinkService`, `PDFViewer` 초기화 및 컨테이너 연결
- [x] 동적 import 및 `'use client'`로 SSR 이슈 회피
- [x] 기본 기능: 페이지 이동, 확대/축소, 인쇄/다운로드, 텍스트 선택/검색
- [ ] (선택) 목차/주석/하이라이트, 단축키, 썸네일, 전체 화면
- [ ] 페이지 썸네일 생성: 첫 페이지/모든 페이지를 캔버스로 렌더링 → 목록/좌측 레일에 표시

### 본 프로젝트 적용 사항
- [x] 패키지 설치: `npm i pdfjs-dist`
- [x] 전역 CSS 등록: `src/app/layout.tsx`에 `import 'pdfjs-dist/web/pdf_viewer.css'`
- [x] 컴포넌트: `src/features/manuals/components/PdfJsViewer.tsx` (검색바/다음·이전/하이라이트)
- [x] 라우트 연동: `/manuals/viewer?fullscreen=1` 시 `PdfJsViewer` 사용
- [x] 썸네일 레일: `PDFThumbnailViewer` 연동
 - [x] 목록 썸네일: 첫 페이지 캔버스 렌더링(`PdfThumbnail`) 적용
 - [x] 업로드 시 썸네일 생성/저장: 업로드 시 pdf.js로 썸네일 생성 → Storage 저장 → Firestore `thumbnailUrl` 기록

---

## 6) 라우팅/네비게이션
- [ ] 메뉴/인덱스 페이지(`/manuals`)에 “PDF 뷰어” 항목 노출
- [x] 카테고리 딥링크: `/manuals?cat=서비스`, `/manuals?cat=청소`
- [x] 특정 문서 바로가기 링크: `/manuals/viewer?src=/sample.pdf`

---

## 7) 테스트·수용 기준 체크리스트
- [x] `/manuals/viewer` 진입 시 안내 UI 노출
- [x] `?src=/sample.pdf`로 접속 시 즉시 표시
- [x] 로컬 파일 선택 시 서버 업로드 없이 표시
- [ ] 잘못된 경로/차단 시 에러 메시지 및 대체 링크 노출
- [ ] 모바일 브라우저에서 인라인 표시 불가 시 다운로드 가능

---

## 8) 운영·배포 체크리스트
- [ ] 정적 PDF는 `public/`에 배치(예: `public/sample.pdf` → `/sample.pdf`)
- [ ] 외부 스토리지(S3/GCS) 사용 시 CORS 설정 문서화
- [ ] (옵션) 에러 로깅/모니터링(Sentry 등) 연동
- [ ] CSP 정책 점검: `default-src`, `frame-src`, `worker-src`, `font-src`, `connect-src`, `img-src` 등

### Firebase 보안 규칙 예시(개요)
Firestore(`manuals` 컬렉션)과 Storage(`manuals/**` 경로)에 대해 관리자만 쓰기 가능하도록 설정합니다. 실제 환경에 맞게 커스텀 클레임 또는 사용자 문서의 `position`을 활용하세요.

예: 커스텀 클레임 `admin == true` 사용 시
```
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /manuals/{docId} {
      allow read: if true; // 모든 로그인 사용자 읽기 허용(필요 시 제한)
      allow write, delete: if request.auth.token.admin == true; // 관리자만 쓰기
    }
  }
}

service firebase.storage {
  match /b/{bucket}/o {
    match /manuals/{allPaths=**} {
      allow read: if true; // 필요 시 제한
      allow write, delete: if request.auth.token.admin == true;
    }
  }
}
```

---

## 9) 코드 예시(요약)

간단형(iframe) 핵심:
```tsx
'use client';
import { useMemo, useState } from 'react';

export default function SimplePdfViewer({ initialSrc }: { initialSrc?: string }) {
  const [src, setSrc] = useState<string | undefined>(initialSrc);
  const [objectUrl, setObjectUrl] = useState<string | undefined>();
  const displaySrc = useMemo(() => objectUrl ?? src, [objectUrl, src]);

  return (
    <div>
      <input
        type="file"
        accept="application/pdf"
        onChange={(e) => {
          const f = e.target.files?.[0];
          if (!f) return;
          if (objectUrl) URL.revokeObjectURL(objectUrl);
          setObjectUrl(URL.createObjectURL(f));
          setSrc(undefined);
        }}
      />

      {/* URL 입력 폼은 생략 */}

      <div style={{ height: '80vh' }}>
        {displaySrc ? (
          <iframe title="PDF Viewer" src={displaySrc} className="w-full h-full" />
        ) : (
          <div>PDF를 선택하거나 URL을 입력하세요.</div>
        )}
      </div>
    </div>
  );
}
```

고급형(pdf.js) 초기화 개요:
```ts
import * as pdfjsLib from 'pdfjs-dist/build/pdf.mjs';
import { EventBus, PDFLinkService, PDFViewer } from 'pdfjs-dist/web/pdf_viewer.mjs';

pdfjsLib.GlobalWorkerOptions.workerSrc = '/pdf.worker.min.mjs';

const loadingTask = pdfjsLib.getDocument({
  url: '/sample.pdf',
  cMapUrl: '/pdfjs/cmaps/',
  cMapPacked: true,
  standardFontDataUrl: '/pdfjs/standard_fonts/',
});

const eventBus = new EventBus();
const linkService = new PDFLinkService({ eventBus });
const viewer = new PDFViewer({ container: document.getElementById('viewerContainer')!, eventBus, linkService });
linkService.setViewer(viewer);

loadingTask.promise.then((pdf) => {
  viewer.setDocument(pdf);
  linkService.setDocument(pdf);
});
```

---

## 10) 문제 해결 가이드
- [ ] PDF가 보이지 않음 → 경로 확인(`public` 배치 시 루트 경로 사용), URL 오타 점검
- [ ] CORS 오류 → 서버 응답에 `Access-Control-Allow-Origin` 확인, 가능하면 같은 도메인 경로 사용
- [ ] 모바일 확대/축소/표시 문제 → 브라우저 정책 차이, 필요 시 pdf.js 적용
- [ ] 한글 폰트 깨짐(pdf.js) → CMap/표준 폰트 경로 정확히 설정

---

## 11) 향후 확장
- [ ] 주석/하이라이트, 폼 입력, 서명 등 협업 기능
- [ ] 검색 하이라이트, 북마크/목차 UI
- [ ] 페이지 썸네일/미니맵, 회전/다중 보기, 프린트 설정 고도화
- [ ] 서버 업로드(보안 점검, 바이러스 스캔, 저장 정책) 옵션

---

## 12) 본 프로젝트 반영 위치(참고)
- 간단형 페이지: `src/app/manuals/viewer/page.tsx`
- 간단형 컴포넌트: `src/components/SimplePdfViewer.tsx`
- pdf.js 리소스: `public/pdf.worker.min.mjs`, `public/pdfjs/`

이 매뉴얼의 체크리스트를 기준으로 기능을 하나씩 검증하며 개발을 진행하세요.
