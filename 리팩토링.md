# 리팩토링 계획: 완벽한 게시판을 향한 잔인한 여정

이 계획은 당신의 현재 게시판이 가진 모든 추악한 결함을 뿌리 뽑고, 글쓰기, 수정, 삭제, 댓글, 답글, 권한 관리 등 모든 기능을 완벽하게 구현하기 위한 철저하고 무자비한 로드맵이다. 기존의 어설픈 구현 방식은 용납되지 않을 것이며, 각 단계는 명확한 목표와 함께 당신의 무능함을 개선할 기회를 제공할 것이다.

## 1. 핵심 아키텍처 재구축: 서버와 클라이언트의 성역 분리

**목표:** `firebase-admin`이 클라이언트 번들에 포함되는 치명적인 오류를 영원히 제거하고, 서버와 클라이언트 간의 명확하고 견고한 통신 채널을 확립한다. 모든 데이터 접근은 그 본연의 위치에서 이루어져야 한다.

- [ ] **1.1 `boardRepo.ts`의 완전한 말살:**
    - [ ] `src/features/board/services/boardRepo.ts` 파일을 완전히 삭제하라. 이 파일은 혼돈의 상징이며, 더 이상 존재할 가치가 없다.
- [ ] **1.2 `actions.ts`의 서버 액션 순수성 확보:**
    - [ ] `src/features/board/actions.ts` 파일 내에 `firebase/firestore`에서 임포트된 모든 잔재(예: `collection`, `query`, `orderBy`, `where`, `limit`, `getDocs`, `startAfter`)를 제거하라. 이들은 서버 액션의 영역에 속하지 않는다.
    - [ ] `actions.ts` 내의 모든 데이터베이스 상호작용은 `db` 객체(즉, `firebase-admin` 인스턴스)의 메서드(예: `db.collection().doc().get()`, `db.runTransaction()`, `FieldValue.increment()`)를 직접 사용하도록 강제하라. `firebase/firestore`의 함수들을 사용하는 모든 코드는 `firebase-admin`의 동등한 기능으로 대체되어야 한다.
- [ ] **1.3 `firebaseAdmin.ts`의 역할 명확화:**
    - [ ] `src/lib/firebaseAdmin.ts` 파일이 오직 `firebase-admin` SDK 초기화 및 `auth`, `db` 인스턴스 익스포트만을 담당하는지 확인하라. 이 파일은 클라이언트 측 코드에서 절대 임포트되어서는 안 된다.

## 2. 게시물 기능 완벽 구현: CRUD 및 권한 관리

**목표:** 게시물 생성, 조회, 수정, 삭제 기능을 완벽하게 구현하고, 각 작업에 대한 사용자 권한을 서버 측에서 철저히 검증한다.

- [ ] **2.1 게시물 생성 (`addPostAction`):**
    - [ ] `src/features/board/actions.ts` 내 `addBoardPostServerAction`이 `BoardPost`의 모든 필수 필드를 정확히 처리하는지 검증하라.
    - [ ] `addPostAction` (폼 제출용)이 사용자 인증 및 입력 유효성 검사를 철저히 수행한 후 `addBoardPostServerAction`을 호출하는지 확인하라.
    - [ ] **UI 개선:** 글쓰기 버튼 클릭 시 새 페이지(`/board/write`)로 이동하도록 `src/app/board/BoardClientPage.tsx`를 수정하라.
        - [ ] `BoardClientPage.tsx`에서 `showForm` 상태 및 `BoardForm` 조건부 렌더링 로직을 제거하라.
        - [ ] 글쓰기 버튼을 `next/link` 컴포넌트로 변경하여 `/board/write` 경로로 연결하라.
    - [ ] **새 글쓰기 페이지 생성:** `src/app/board/write/page.tsx` 파일을 생성하고, 이 페이지에서 `BoardForm` 컴포넌트를 렌더링하도록 구현하라.
    - [ ] **폼 제출 후 리디렉션:** `BoardForm`의 제출 성공 시 `next/navigation`의 `redirect('/board')`를 사용하여 사용자를 게시물 목록 페이지로 리디렉션하라. 이는 새로운 게시물이 즉시 반영되도록 서버 측 캐시를 강제로 재검증할 것이다.
- [ ] **2.2 게시물 조회 (`getBoardPostsOnceAction`, `getBoardPostByNoAction`):**
    - [ ] `src/features/board/actions.ts` 내 `getBoardPostsOnceAction`이 `createdAt` 기준으로 정확히 정렬되고 페이지네이션을 처리하는지 재검증하라. (로그를 통해 확인된 문제 없음)
    - [ ] `getBoardPostByNoAction`이 단일 게시물을 정확히 조회하는지 확인하라.
    - [ ] **UI 업데이트:** `src/app/board/page.tsx` 및 `src/app/board/[no]/page.tsx`에서 `getBoardPostsOnce` 및 `getBoardPostByNo` 호출을 `actions.ts`의 해당 서버 액션으로 변경하라. (이미 완료됨)
- [ ] **2.3 게시물 수정 (`updatePostAction`, `updateBoardPostServerAction`):**
    - [ ] `src/features/board/actions.ts` 내 `updateBoardPostServerAction`이 `BoardPost`의 특정 필드만 업데이트하는 `patch` 로직을 정확히 처리하는지 확인하라.
    - [ ] `updatePostAction` (폼 제출용)이 사용자 인증 및 권한 검사(관리자 또는 작성자 본인)를 철저히 수행한 후 `updateBoardPostServerAction`을 호출하는지 확인하라.
    - [ ] **UI 업데이트:** `src/app/board/[no]/edit/page.tsx`에서 `getBoardPostByNo` 호출을 `getBoardPostByNoAction`으로 변경하라. (이미 완료됨)
- [ ] **2.4 게시물 삭제 (`deletePostAction`, `deleteBoardPostServerAction`):**
    - [ ] `src/features/board/actions.ts` 내 `deleteBoardPostServerAction`이 지정된 게시물을 안전하게 삭제하는지 확인하라.
    - [ ] `deletePostAction` (폼 제출용)이 사용자 인증 및 권한 검사(관리자 또는 작성자 본인)를 철저히 수행한 후 `deleteBoardPostServerAction`을 호출하는지 확인하라.
- [ ] **2.5 조회수 증가 (`incrementBoardViewsAction`):**
    - [ ] `src/features/board/actions.ts` 내 `incrementBoardViewsAction`이 게시물의 조회수를 정확히 증가시키는지 확인하라. 이 함수는 클라이언트에서 직접 호출되어서는 안 되며, 서버 액션 내에서만 사용되어야 한다.

## 3. 댓글 및 답글 기능 완벽 구현: CRUD 및 실시간 업데이트

**목표:** 댓글 및 답글의 생성, 조회, 수정, 삭제 기능을 완벽하게 구현하고, 실시간 업데이트를 통해 사용자 경험을 극대화한다.

- [ ] **3.1 댓글 생성 (`addCommentServerAction`):**
    - [ ] `src/features/board/actions.ts` 내 `addCommentServerAction`이 댓글을 정확히 추가하고 게시물의 `commentsCount`를 증가시키는지 확인하라.
    - [ ] **UI 통합:** `CommentForm` 컴포넌트가 `addCommentServerAction`을 호출하도록 수정하라.
- [ ] **3.2 댓글 조회 (`getCommentsSubscription`):**
    - [ ] `src/features/board/services/commentClientService.ts` 내 `getCommentsSubscription`이 `firebase-client`를 사용하여 실시간으로 댓글을 구독하고 `CommentList`에 데이터를 제공하는지 확인하라.
    - [ ] `useCommentsQuery` (또는 `useCommentsSubscription`) 훅이 `commentClientService.getCommentsSubscription`을 정확히 호출하는지 확인하라.
- [ ] **3.3 댓글 수정 (`updateCommentServerAction`):**
    - [ ] `src/features/board/actions.ts` 내 `updateCommentServerAction`이 댓글을 정확히 수정하고 권한 검사를 수행하는지 확인하라.
    - [ ] **UI 통합:** 댓글 수정 UI가 `updateCommentServerAction`을 호출하도록 수정하라.
- [ ] **3.4 댓글 삭제 (`deleteCommentServerAction`):**
    - [ ] `src/features/board/actions.ts` 내 `deleteCommentServerAction`이 댓글을 정확히 삭제하고 게시물의 `commentsCount`를 감소시키며 권한 검사를 수행하는지 확인하라.
    - [ ] **UI 통합:** 댓글 삭제 UI가 `deleteCommentServerAction`을 호출하도록 수정하라.
- [ ] **3.5 댓글 '좋아요' 토글 (`toggleBoardCommentLikeServerAction`):**
    - [ ] `src/features/board/actions.ts` 내 `toggleBoardCommentLikeServerAction`이 댓글의 '좋아요' 상태를 정확히 토글하고 `likes` 수를 업데이트하는지 확인하라.
    - [ ] **UI 통합:** 댓글 '좋아요' 버튼이 `toggleBoardCommentLikeServerAction`을 호출하도록 수정하라.
- [ ] **3.6 답글 기능 구현 (선택 사항, 고급):**
    - [ ] 댓글에 대한 답글 기능을 구현할지 결정하라. (예: `parentId` 필드를 활용하여 계층 구조 구현)
    - [ ] 답글 생성, 조회, 수정, 삭제에 대한 서버 액션 및 UI를 구현하라.

## 4. 권한 관리 및 보안 강화

**목표:** 모든 민감한 작업에 대해 사용자 역할(admin, buttoner) 기반의 권한 검사를 서버 측에서 철저히 수행하여 보안을 강화한다.

- [ ] **4.1 `AuthenticatedUser` 역할 검증:**
    - [ ] `src/lib/session.ts` 내 `AuthenticatedUser` 인터페이스에 `position` 필드가 정확히 정의되어 있는지 확인하라.
    - [ ] 모든 서버 액션(게시물/댓글 CRUD) 내에서 `getAuthenticatedUser()`를 통해 현재 사용자의 `position`을 가져와 권한 검사에 활용하라.
- [ ] **4.2 관리자 권한:**
    - [ ] 관리자(`admin`)는 모든 게시물과 댓글을 수정/삭제할 수 있는 권한을 가지는지 확인하라.
- [ ] **4.3 작성자 본인 권한:**
    - [ ] 게시물/댓글의 작성자(`authorUid`)는 자신의 게시물/댓글을 수정/삭제할 수 있는 권한을 가지는지 확인하라.
- [ ] **4.4 익명 게시물/댓글 처리:**
    - [ ] 익명 게시물/댓글의 경우, 수정/삭제 권한을 어떻게 처리할지 명확히 정의하고 구현하라. (예: 비밀번호 확인 또는 특정 세션 기반 토큰)

## 5. UI/UX 개선 및 최적화

**목표:** 사용자 경험을 향상시키고, 애플리케이션의 성능을 최적화한다.

- [ ] **5.1 로딩 상태 및 에러 처리:**
    - [ ] 모든 데이터 페칭 및 뮤테이션 작업에 대해 로딩 스피너, 에러 메시지 등 적절한 UI 피드백을 제공하라.
- [ ] **5.2 낙관적 UI 업데이트:**
    - [ ] 게시물/댓글 생성, 수정, 삭제, 좋아요 토글 시 `react-query`의 낙관적 업데이트를 적극 활용하여 즉각적인 사용자 피드백을 제공하라.
- [ ] **5.3 페이지네이션/무한 스크롤 최적화:**
    - [ ] `useInfinitePostsQuery`의 `getNextPageParam` 로직이 효율적으로 다음 페이지를 가져오는지 확인하라.
    - [ ] 스크롤 이벤트 리스너가 최적화되어 불필요한 리렌더링을 방지하는지 확인하라.
- [ ] **5.4 검색 기능 개선:**
    - [ ] 게시물 검색 기능이 효율적으로 작동하는지 확인하라. (현재는 `title`에 대한 단순 `where` 절 사용)
    - [ ] 필요하다면 더 고급 검색 기능(예: 전문 검색)을 고려하라.
- [ ] **5.5 코드 스플리팅 및 레이지 로딩:**
    - [ ] `BoardForm`과 같이 초기 로드에 필수적이지 않은 컴포넌트들을 `React.lazy`와 `Suspense`를 사용하여 레이지 로딩하는지 확인하라.
- [ ] **5.6 UI 일관성:**
    - [ ] 모든 UI 요소가 일관된 디자인 시스템을 따르는지 확인하라.

---

이 계획은 당신의 게시판을 단순한 기능 집합이 아닌, 견고하고 효율적이며 사용자 친화적인 완벽한 시스템으로 탈바꿈시킬 것이다. 각 단계를 철저히 이행하고, 어떠한 타협도 허용하지 마라.
