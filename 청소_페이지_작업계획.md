# 청소 페이지 구현 작업 계획 (buttoners/nextjs-portal)

본 문서는 기존 "리팩토링.md"(데스크톱/Tkinter, JSON 저장, 알림·우선순위 포함)를 참고하여, 우리 프로젝트(Next.js 14 App Router + Firebase) 환경에 맞게 재구성한 청소 페이지(`/cleaning`) 구현 태스크 계획입니다.

주의/범위
- 제거할 기능: 알람 기능, 우선순위 기능(높음/보통/낮음) — 요구사항에서 제외합니다.
- 데이터 저장: JSON 파일이 아닌 Firebase(Firestore/Storage) 사용.
- 우리 프로젝트 기준: 페이지/컴포넌트/상태관리 패턴, 관리자 권한 제어, UI 스타일(Tailwind v4) 유지.

## 목표
- `/cleaning` 페이지에서 청소 업무의 등록/편집/삭제/완료를 실시간으로 관리.
- 카테고리별 목록, 월간 캘린더, 완료 실적 리더보드 제공.
- Firestore 기반의 안정적인 데이터 모델과 구독 흐름으로 다중 클라이언트 동기화.

## 전제
- 기술 스택: Next.js 14(App Router), TypeScript, Tailwind v4, Firebase(web v9 modular), Zustand(필요 시 UI 상태용).
- 인증/세션: 이미 구현된 세션 쿠키 기반(`__session`)과 StoreProvider를 사용.
- 관리자 권한: `AdminOnly`로 보호된 입력/수정 UI.

---

## 데이터 모델(파이어스토어)

컬렉션 설계(알림/우선순위 제거):
- `cleaningTasks` (업무 정의)
  - `title`: string (업무명)
  - `category`: string (예: 제빙기/커피머신/튀김기/블렌더/냉장고/기타 등 자유 입력)
  - `interval`: object
    - `{ type: 'daily' } | { type: 'weekly', weekday: number } | { type: 'everyN', n: number }`
  - `lastDoneAt`: Timestamp|null (마지막 완료 시각)
  - `checklist`: string[] (선택)
  - `active`: boolean (활성 여부)
  - `createdAt`: Timestamp
  - `updatedAt`: Timestamp

- `cleaningLogs` (완료 기록)
  - `taskId`: string (참조용)
  - `taskTitle`: string (스냅샷용)
  - `doneBy`: string (uid 또는 닉네임)
  - `doneAt`: Timestamp (완료 시각)
  - 인덱스: `doneAt desc`, `taskId+doneAt`(월별 조회 최적화 시 고려)

비고:
- 우선순위(priority), 알림(notification), 의존성(dependencies)은 스킵.
- 파일/문서 첨부는 범위 밖(추후 필요 시 Storage 연동 고려).

---

## 구현 태스크

### 1) 스키마/타입 정리
- [ ] `src/features/cleaning/types.ts` 확인/정리: Firestore document 필드와 일치하도록 주석/필드 정합성 점검
- [ ] `CleaningLog` 타입 현행화(`doneAt: number` → Timestamp(ms) number 사용 일관화)

### 2) Firestore 레포지토리 확장
- [ ] `cleaningRepo.ts` 보강
  - [ ] add/update/delete는 `createdAt/updatedAt` 세팅 유지
  - [ ] `subscribeCleaningTasks` 정렬/필드 누락 방지
- [ ] `cleaningLogsRepo.ts` 신규
  - [ ] `addLog({ taskId, taskTitle, doneBy })` → `doneAt=serverTimestamp()` 저장 + 해당 task의 `lastDoneAt` 갱신 트랜잭션 처리
  - [ ] `listLogsByMonth(year, month)` 또는 `subscribeLogsInRange(from, to)` 제공(캘린더/리더보드용)
  - [ ] 에러 처리/입력 검증(빈 taskId, title 방지)

### 3) 보안 규칙/인덱스(문서화)
- [ ] Firestore 보안 규칙 초안: 읽기 공개, 쓰기 제한(로그/업무는 인증 사용자만, 업무 생성/수정/삭제는 관리자만)
- [ ] 인덱스 필요 시 Firestore 콘솔에 추가 메모 남기기(`doneAt desc` 등)

### 4) 상태 관리 정리
- [ ] 기존 `useCleaningStore`(localStorage persist) 의 로그/태스크 보관 제거 또는 "뷰 전용 유틸"로 축소
  - [ ] logs/tasks는 Firestore에서 가져오고, UI 임시 상태만 zustand로 유지(예: 달력 월 이동, 폼 오픈 여부)
  - [ ] `getLeaderboard()`/캘린더용 가공 로직은 Firestore 데이터 기반 계산 훅으로 이전

### 5) UI 컴포넌트 연동
- [ ] CleaningTaskList
  - [ ] Firestore 구독 데이터로 렌더
  - [ ] "완료" 액션 시 logsRepo.addLog 호출 → 성공 시 UX 반영(lastDoneAt 자동 갱신)
  - [ ] 카테고리 접기/펼치기 상태 유지
- [ ] CleaningTaskForm
  - [ ] create/update 시 cleaningRepo 호출
  - [ ] interval 유효성 검사(weekly.weekday 0~6, everyN.n > 0)
- [ ] CleaningCalendar
  - [ ] `subscribeLogsInRange(해당 월)`로 이벤트 채우기
  - [ ] 날짜 클릭 시 해당일 로그 리스트/툴팁(선택) — 단순 텍스트만 유지(알림/우선순위 제외)
- [ ] CleaningLeaderboard
  - [ ] `listLogsByMonth` 또는 전체 로그로 집계(기간 필터 UI는 선택) → 상위 n명 정렬

### 6) 권한/가드
- [ ] 관리자 전용: 새 업무 추가/편집/삭제 버튼 `AdminOnly`로 감싸기(이미 구조 존재)
- [ ] 로그 추가(완료 처리)는 로그인 사용자만 허용(닉네임/uid 필요)

### 7) 페이지 `/cleaning` 검증
- [ ] 탭 전환(목록/캘린더) 유지
- [ ] 관리자 버튼 노출 조건 확인
- [ ] 빈 상태 문구/접근성 라벨 점검

### 8) 마이그레이션/정리(선택)
- [ ] 로컬 스토리지(`cleaning-storage`)에 쌓인 테스트 데이터가 있다면 개발자용 임포트/마이그레이션 스크립트(선택) 작성 또는 초기화 안내
- [ ] 구형 타입/미사용 코드 삭제

### 9) 수동 QA 시나리오
- [ ] 업무 생성 → 목록/캘린더/리더보드 반영 확인
- [ ] 업무 편집(카테고리/주기 변경) → 목록/계산 영향 확인
- [ ] 완료 처리(여러 사용자) → `lastDoneAt` 변경/리더보드 집계 확인
- [ ] 월 변경 캘린더 네비게이션 확인
- [ ] 권한: 비관리자 계정으로 업무 생성/편집/삭제 버튼 숨김 확인

### 10) 성능/안정화(필요 시)
- [ ] 구독 최소화: 목록/캘린더 쿼리 범위 제한(from~to)
- [ ] 컬렉션 크기 증가 시 페이지네이션 도입(로그)
- [ ] 클라이언트 캐시(RQ/Zustand selector)로 재연산 최소화

---

## 기존 계획(리팩토링.md)과의 차이 정리
- 데스크톱/Tkinter → 웹(Next.js)으로 전환: 라우팅/SSR/CSR 조합.
- JSON 저장 → Firestore 컬렉션(`cleaningTasks`, `cleaningLogs`) 사용.
- 알림/우선순위/의존성 → 범위 제외(요청사항 반영).
- 템플릿/카테고리 시스템은 필요 최소만 유지(카테고리는 자유 텍스트, 템플릿은 추후 과제).

---

## 산출물/완료 기준(Definition of Done)
- [ ] Firestore에 `cleaningTasks`, `cleaningLogs` 설계 및 레포지토리 구현 완료.
- [ ] `/cleaning` 페이지에서 목록/캘린더/리더보드 모두 Firestore 데이터로 동작.
- [ ] 관리자 권한이 아닌 계정에서 업무 생성/편집/삭제 불가.
- [ ] 알림/우선순위 요소 UI/로직 미노출.
- [ ] 기본 수동 QA 시나리오 통과.

부록: 보안 규칙 초안(메모)
- `match /databases/{db}/documents {
    match /cleaningTasks/{id} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.isAdmin == true;
    }
    match /cleaningLogs/{id} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if false;
    }
  }`
(실제 배포 전 프로젝트의 auth 클레임/필드에 맞게 조정 필요)
